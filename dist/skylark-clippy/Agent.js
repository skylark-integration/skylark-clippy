/**
 * skylark-clippy - A version of clippy that ported to running on skylarkjs ui.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-clippy/
 * @license MIT
 */
define(["skylark-jquery","./Queue","./Animator","./Balloon"],function(t,i,e,s){"use strict";return class{constructor(o,n,h){this.path=o,this._queue=new i(t.proxy(this._onQueueEmpty,this)),this._el=t('<div class="clippy"></div>').hide(),t(document.body).append(this._el),this._animator=new e(this._el,o,n,h),this._balloon=new s(this._el),this._setupEvents()}gestureAt(t,i){let e=this._getDirection(t,i),s="Gesture"+e,o="Look"+e,n=this.hasAnimation(s)?s:o;return this.play(n)}hide(t,i){this._hidden=!0;let e=this._el;return this.stop(),t?(this._el.hide(),this.stop(),this.pause(),void(i&&i())):this._playInternal("Hide",function(){e.hide(),this.pause(),i&&i()})}moveTo(i,s,o){let n="Move"+this._getDirection(i,s);void 0===o&&(o=1e3),this._addToQueue(function(h){if(0===o)return this._el.css({top:s,left:i}),this.reposition(),void h();if(!this.hasAnimation(n))return void this._el.animate({top:s,left:i},o,h);let a=t.proxy(function(n,a){a===e.States.EXITED&&h(),a===e.States.WAITING&&this._el.animate({top:s,left:i},o,t.proxy(function(){this._animator.exitAnimation()},this))},this);this._playInternal(n,a)},this)}_playInternal(i,e){this._isIdleAnimation()&&this._idleDfd&&"pending"===this._idleDfd.state()&&this._idleDfd.done(t.proxy(function(){this._playInternal(i,e)},this)),this._animator.showAnimation(i,e)}play(i,s,o){return!!this.hasAnimation(i)&&(void 0===s&&(s=5e3),this._addToQueue(function(n){let h=!1;s&&window.setTimeout(t.proxy(function(){h||this._animator.exitAnimation()},this),s),this._playInternal(i,function(t,i){i===e.States.EXITED&&(h=!0,o&&o(),n())})},this),!0)}show(i){if(this._hidden=!1,i)return this._el.show(),this.resume(),void this._onQueueEmpty();if("auto"===this._el.css("top")||"auto"===!this._el.css("left")){let i=.8*t(window).width(),e=.8*(t(window).height()+t(document).scrollTop());this._el.css({top:e,left:i})}return this.resume(),this.play("Show")}speak(t,i){this._addToQueue(function(e){this._balloon.speak(e,t,i)},this)}closeBalloon(){this._balloon.hide()}delay(t){t=t||250,this._addToQueue(function(i){this._onQueueEmpty(),window.setTimeout(i,t)})}stopCurrent(){this._animator.exitAnimation(),this._balloon.close()}stop(){this._queue.clear(),this._animator.exitAnimation(),this._balloon.hide()}hasAnimation(t){return this._animator.hasAnimation(t)}animations(){return this._animator.animations()}animate(){let t=this.animations(),i=t[Math.floor(Math.random()*t.length)];return 0===i.indexOf("Idle")?this.animate():this.play(i)}_getDirection(t,i){let e=this._el.offset(),s=this._el.height(),o=this._el.width(),n=e.left+o/2,h=e.top+s/2-i,a=n-t,l=Math.round(180*Math.atan2(h,a)/Math.PI);return-45<=l&&l<45?"Right":45<=l&&l<135?"Up":135<=l&&l<=180||-180<=l&&l<-135?"Left":-135<=l&&l<-45?"Down":"Top"}_onQueueEmpty(){if(this._hidden||this._isIdleAnimation())return;let i=this._getIdleAnimation();this._idleDfd=t.Deferred(),this._animator.showAnimation(i,t.proxy(this._onIdleComplete,this))}_onIdleComplete(t,i){i===e.States.EXITED&&this._idleDfd.resolve()}_isIdleAnimation(){let t=this._animator.currentAnimationName;return t&&0===t.indexOf("Idle")}_getIdleAnimation(){let t=this.animations(),i=[];for(let e=0;e<t.length;e++){let s=t[e];0===s.indexOf("Idle")&&i.push(s)}return i[Math.floor(Math.random()*i.length)]}_setupEvents(){t(window).on("resize",t.proxy(this.reposition,this)),this._el.on("mousedown",t.proxy(this._onMouseDown,this)),this._el.on("dblclick",t.proxy(this._onDoubleClick,this))}_onDoubleClick(){this.play("ClickedOn")||this.animate()}reposition(){if(!this._el.is(":visible"))return;let i=this._el.offset(),e=this._el.outerHeight(),s=this._el.outerWidth(),o=t(window).width(),n=t(window).height(),h=t(window).scrollTop(),a=t(window).scrollLeft(),l=i.top-h,r=i.left-a;l-5<0?l=5:l+e+5>n&&(l=n-e-5),r-5<0?r=5:r+s+5>o&&(r=o-s-5),this._el.css({left:r,top:l}),this._balloon.reposition()}_onMouseDown(t){t.preventDefault(),this._startDrag(t)}_startDrag(i){this.pause(),this._balloon.hide(!0),this._offset=this._calculateClickOffset(i),this._moveHandle=t.proxy(this._dragMove,this),this._upHandle=t.proxy(this._finishDrag,this),t(window).on("mousemove",this._moveHandle),t(window).on("mouseup",this._upHandle),this._dragUpdateLoop=window.setTimeout(t.proxy(this._updateLocation,this),10)}_calculateClickOffset(t){let i=t.pageX,e=t.pageY,s=this._el.offset();return{top:e-s.top,left:i-s.left}}_updateLocation(){this._el.css({top:this._targetY,left:this._targetX}),this._dragUpdateLoop=window.setTimeout(t.proxy(this._updateLocation,this),10)}_dragMove(t){t.preventDefault();let i=t.clientX-this._offset.left,e=t.clientY-this._offset.top;this._targetX=i,this._targetY=e}_finishDrag(){window.clearTimeout(this._dragUpdateLoop),t(window).off("mousemove",this._moveHandle),t(window).off("mouseup",this._upHandle),this._balloon.show(),this.reposition(),this.resume()}_addToQueue(i,e){e&&(i=t.proxy(i,e)),this._queue.queue(i)}pause(){this._animator.pause(),this._balloon.pause()}resume(){this._animator.resume(),this._balloon.resume()}}});
//# sourceMappingURL=sourcemaps/Agent.js.map
