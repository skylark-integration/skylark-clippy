{"version":3,"sources":["Agent.js"],"names":["define","$","Queue","Animator","Balloon","[object Object]","path","data","sounds","this","_queue","proxy","_onQueueEmpty","_el","hide","document","body","append","_animator","_balloon","_setupEvents","x","y","d","_getDirection","gAnim","lookAnim","animation","hasAnimation","play","fast","callback","_hidden","el","stop","pause","_playInternal","duration","anim","undefined","_addToQueue","complete","css","top","left","reposition","animate","name","state","States","EXITED","WAITING","exitAnimation","_isIdleAnimation","_idleDfd","done","showAnimation","timeout","cb","completed","window","setTimeout","show","resume","width","height","scrollTop","text","hold","speak","time","close","clear","animations","Math","floor","random","length","indexOf","offset","h","w","centerX","a","b","r","round","atan2","PI","idleAnim","_getIdleAnimation","Deferred","_onIdleComplete","resolve","c","currentAnimationName","i","push","on","_onMouseDown","_onDoubleClick","is","o","bH","outerHeight","bW","outerWidth","wW","wH","sT","sL","scrollLeft","e","preventDefault","_startDrag","_offset","_calculateClickOffset","_moveHandle","_dragMove","_upHandle","_finishDrag","_dragUpdateLoop","_updateLocation","mouseX","pageX","mouseY","pageY","_targetY","_targetX","clientX","clientY","clearTimeout","off","func","scope","queue"],"mappings":"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","file":"../Agent.js","sourcesContent":["define([\n    'skylark-jquery',\n    './Queue',\n    './Animator',\n    './Balloon'\n], function ($, Queue, Animator, Balloon) {\n    'use strict';\n     class Agent {\n        constructor(path, data, sounds) {\n            this.path = path;\n            this._queue = new Queue($.proxy(this._onQueueEmpty, this));\n            this._el = $('<div class=\"clippy\"></div>').hide();\n            $(document.body).append(this._el);\n            this._animator = new Animator(this._el, path, data, sounds);\n            this._balloon = new Balloon(this._el);\n            this._setupEvents();\n        }\n        gestureAt(x, y) {\n            let d = this._getDirection(x, y);\n            let gAnim = 'Gesture' + d;\n            let lookAnim = 'Look' + d;\n            let animation = this.hasAnimation(gAnim) ? gAnim : lookAnim;\n            return this.play(animation);\n        }\n        hide(fast, callback) {\n            this._hidden = true;\n            let el = this._el;\n            this.stop();\n            if (fast) {\n                this._el.hide();\n                this.stop();\n                this.pause();\n                if (callback)\n                    callback();\n                return;\n            }\n            return this._playInternal('Hide', function () {\n                el.hide();\n                this.pause();\n                if (callback)\n                    callback();\n            });\n        }\n        moveTo(x, y, duration) {\n            let dir = this._getDirection(x, y);\n            let anim = 'Move' + dir;\n            if (duration === undefined)\n                duration = 1000;\n            this._addToQueue(function (complete) {\n                if (duration === 0) {\n                    this._el.css({\n                        top: y,\n                        left: x\n                    });\n                    this.reposition();\n                    complete();\n                    return;\n                }\n                if (!this.hasAnimation(anim)) {\n                    this._el.animate({\n                        top: y,\n                        left: x\n                    }, duration, complete);\n                    return;\n                }\n                let callback = $.proxy(function (name, state) {\n                    if (state === Animator.States.EXITED) {\n                        complete();\n                    }\n                    if (state === Animator.States.WAITING) {\n                        this._el.animate({\n                            top: y,\n                            left: x\n                        }, duration, $.proxy(function () {\n                            this._animator.exitAnimation();\n                        }, this));\n                    }\n                }, this);\n                this._playInternal(anim, callback);\n            }, this);\n        }\n        _playInternal(animation, callback) {\n            if (this._isIdleAnimation() && this._idleDfd && this._idleDfd.state() === 'pending') {\n                this._idleDfd.done($.proxy(function () {\n                    this._playInternal(animation, callback);\n                }, this));\n            }\n            this._animator.showAnimation(animation, callback);\n        }\n        play(animation, timeout, cb) {\n            if (!this.hasAnimation(animation))\n                return false;\n            if (timeout === undefined)\n                timeout = 5000;\n            this._addToQueue(function (complete) {\n                let completed = false;\n                let callback = function (name, state) {\n                    if (state === Animator.States.EXITED) {\n                        completed = true;\n                        if (cb)\n                            cb();\n                        complete();\n                    }\n                };\n                if (timeout) {\n                    window.setTimeout($.proxy(function () {\n                        if (completed)\n                            return;\n                        this._animator.exitAnimation();\n                    }, this), timeout);\n                }\n                this._playInternal(animation, callback);\n            }, this);\n            return true;\n        }\n        show(fast) {\n            this._hidden = false;\n            if (fast) {\n                this._el.show();\n                this.resume();\n                this._onQueueEmpty();\n                return;\n            }\n            if (this._el.css('top') === 'auto' || !this._el.css('left') === 'auto') {\n                let left = $(window).width() * 0.8;\n                let top = ($(window).height() + $(document).scrollTop()) * 0.8;\n                this._el.css({\n                    top: top,\n                    left: left\n                });\n            }\n            this.resume();\n            return this.play('Show');\n        }\n        speak(text, hold) {\n            this._addToQueue(function (complete) {\n                this._balloon.speak(complete, text, hold);\n            }, this);\n        }\n        closeBalloon() {\n            this._balloon.hide();\n        }\n        delay(time) {\n            time = time || 250;\n            this._addToQueue(function (complete) {\n                this._onQueueEmpty();\n                window.setTimeout(complete, time);\n            });\n        }\n        stopCurrent() {\n            this._animator.exitAnimation();\n            this._balloon.close();\n        }\n        stop() {\n            this._queue.clear();\n            this._animator.exitAnimation();\n            this._balloon.hide();\n        }\n        hasAnimation(name) {\n            return this._animator.hasAnimation(name);\n        }\n        animations() {\n            return this._animator.animations();\n        }\n        animate() {\n            let animations = this.animations();\n            let anim = animations[Math.floor(Math.random() * animations.length)];\n            if (anim.indexOf('Idle') === 0) {\n                return this.animate();\n            }\n            return this.play(anim);\n        }\n        _getDirection(x, y) {\n            let offset = this._el.offset();\n            let h = this._el.height();\n            let w = this._el.width();\n            let centerX = offset.left + w / 2;\n            let centerY = offset.top + h / 2;\n            let a = centerY - y;\n            let b = centerX - x;\n            let r = Math.round(180 * Math.atan2(a, b) / Math.PI);\n            if (-45 <= r && r < 45)\n                return 'Right';\n            if (45 <= r && r < 135)\n                return 'Up';\n            if (135 <= r && r <= 180 || -180 <= r && r < -135)\n                return 'Left';\n            if (-135 <= r && r < -45)\n                return 'Down';\n            return 'Top';\n        }\n        _onQueueEmpty() {\n            if (this._hidden || this._isIdleAnimation())\n                return;\n            let idleAnim = this._getIdleAnimation();\n            this._idleDfd = $.Deferred();\n            this._animator.showAnimation(idleAnim, $.proxy(this._onIdleComplete, this));\n        }\n        _onIdleComplete(name, state) {\n            if (state === Animator.States.EXITED) {\n                this._idleDfd.resolve();\n            }\n        }\n        _isIdleAnimation() {\n            let c = this._animator.currentAnimationName;\n            return c && c.indexOf('Idle') === 0;\n        }\n        _getIdleAnimation() {\n            let animations = this.animations();\n            let r = [];\n            for (let i = 0; i < animations.length; i++) {\n                let a = animations[i];\n                if (a.indexOf('Idle') === 0) {\n                    r.push(a);\n                }\n            }\n            let idx = Math.floor(Math.random() * r.length);\n            return r[idx];\n        }\n        _setupEvents() {\n            $(window).on('resize', $.proxy(this.reposition, this));\n            this._el.on('mousedown', $.proxy(this._onMouseDown, this));\n            this._el.on('dblclick', $.proxy(this._onDoubleClick, this));\n        }\n        _onDoubleClick() {\n            if (!this.play('ClickedOn')) {\n                this.animate();\n            }\n        }\n        reposition() {\n            if (!this._el.is(':visible'))\n                return;\n            let o = this._el.offset();\n            let bH = this._el.outerHeight();\n            let bW = this._el.outerWidth();\n            let wW = $(window).width();\n            let wH = $(window).height();\n            let sT = $(window).scrollTop();\n            let sL = $(window).scrollLeft();\n            let top = o.top - sT;\n            let left = o.left - sL;\n            let m = 5;\n            if (top - m < 0) {\n                top = m;\n            } else if (top + bH + m > wH) {\n                top = wH - bH - m;\n            }\n            if (left - m < 0) {\n                left = m;\n            } else if (left + bW + m > wW) {\n                left = wW - bW - m;\n            }\n            this._el.css({\n                left: left,\n                top: top\n            });\n            this._balloon.reposition();\n        }\n        _onMouseDown(e) {\n            e.preventDefault();\n            this._startDrag(e);\n        }\n        _startDrag(e) {\n            this.pause();\n            this._balloon.hide(true);\n            this._offset = this._calculateClickOffset(e);\n            this._moveHandle = $.proxy(this._dragMove, this);\n            this._upHandle = $.proxy(this._finishDrag, this);\n            $(window).on('mousemove', this._moveHandle);\n            $(window).on('mouseup', this._upHandle);\n            this._dragUpdateLoop = window.setTimeout($.proxy(this._updateLocation, this), 10);\n        }\n        _calculateClickOffset(e) {\n            let mouseX = e.pageX;\n            let mouseY = e.pageY;\n            let o = this._el.offset();\n            return {\n                top: mouseY - o.top,\n                left: mouseX - o.left\n            };\n        }\n        _updateLocation() {\n            this._el.css({\n                top: this._targetY,\n                left: this._targetX\n            });\n            this._dragUpdateLoop = window.setTimeout($.proxy(this._updateLocation, this), 10);\n        }\n        _dragMove(e) {\n            e.preventDefault();\n            let x = e.clientX - this._offset.left;\n            let y = e.clientY - this._offset.top;\n            this._targetX = x;\n            this._targetY = y;\n        }\n        _finishDrag() {\n            window.clearTimeout(this._dragUpdateLoop);\n            $(window).off('mousemove', this._moveHandle);\n            $(window).off('mouseup', this._upHandle);\n            this._balloon.show();\n            this.reposition();\n            this.resume();\n        }\n        _addToQueue(func, scope) {\n            if (scope)\n                func = $.proxy(func, scope);\n            this._queue.queue(func);\n        }\n        pause() {\n            this._animator.pause();\n            this._balloon.pause();\n        }\n        resume() {\n            this._animator.resume();\n            this._balloon.resume();\n        }\n    }\n\n    return Agent;\n});"]}